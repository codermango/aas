<%- partial('../editor_sidebar') %>

<div id='content'>
  <div class='panel'>
    <div class='header'>
      <ol class='breadcrumb'>
        <li><a href='/'>主页</a><span class='divider'>/</span></li>
        <% if (typeof(action) !== 'undefined' && action == 'edit') { %>
          <li class='active'>编辑话题</li>
        <% } else { %>
          <li class='active'>发布话题</li>
        <% } %>
      </ol>
    </div>
    <div class='inner post'>
      <% if (typeof(edit_error) !== 'undefined' && edit_error) { %>
        <div class="alert alert-error">
          <a class="close" data-dismiss="alert" href="#">&times;</a>
          <strong><%= edit_error %></strong>
        </div>
      <% } %>
      <% if (typeof(error) !== 'undefined' && error) { %>
        <div class="alert alert-error">
          <strong><%= error %></strong>
        </div>
      <% } else { %>
        <% if (typeof(action) !== 'undefined' && action === 'edit') { %>
          <form id='create_topic_form' class="form-horizontal" action='/topic/<%= topic_id %>/edit' method='post'>
        <% } else { %>
          <form id='create_topic_form' class="form-horizontal" action='/topic/create' method='post'>
      <% } %>
        <fieldset>

          <div class='control-group'>
            <label class='tab-selector control-label'>选择版块：</label>
            <div class='controls'>
              <select class="input-xlarge" name="tab" id="tab-value">
                <option value="">请选择</option>
                  <%
                    var tabValue = '';
                    if (typeof(tab) !== 'undefined') {
                      tabValue = tab;
                    }
                    tabs.forEach(function (pair) {
                      var value = pair[0];
                      var text = pair[1];
                  %>
                    <option value="<%= value %>" <%= tabValue === value ? 'selected': '' %>><%=text%></option>
                  <%});%>
                </select>
            </div>
          </div>

      
          <span id="topic_create_warn"></span>
          <div class='control-group'>
            <label class='control-label' for='name'>标题</label>
            <div class='controls'>
              <input
                class='input-xlarge readonly'
                id='title'
                name='title'
                type='text'
                value="<%= typeof(title) === 'undefined' ? '' : title %>"
              />
              </textarea>
            </div>
          </div>
            

          <!--如果是租房信息则显示填写房屋信息的部分-->
          <div id="rental">
            <div class='control-group'>
              <label class='tab-selector control-label'>选择城市：</label>
              <div class='controls'>
                <select class="input-xlarge" name="city" id="city-value">
                  <option value="">请选择</option>
                  <%
                    var cityValue = '';
                    if (typeof(city) !== 'undefined') {
                      cityValue = city;
                    }
                    cities.forEach(function (pair) {
                      var value = pair[0];
                      var text = pair[1];
                  %>
                  <option value="<%= value %>" <%= cityValue === value ? 'selected': '' %>><%= text %></option>
                  <%});%>
                </select>
              </div>
            </div>

            <div class='control-group'>
              <label class='control-label' for='addr'>地址</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='addr'
                  name='addr'
                  type='text'
                  value="<%= typeof(addr) === 'undefined' ? '' : addr %>"
                />
              </div>
            </div>

            <div class='control-group'>
              <label class='control-label' for='price'>价格</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='price'
                  name='price'
                  type='number'
                  min="0"
                  value="<%= typeof(price) === 'undefined' ? '' : price %>"
                  placeholder="克朗"
                />
              </div>
            </div>

            <div class='control-group'>
              <label class='control-label' for='size'>面积</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='size'
                  name='size'
                  type='number'
                  min="0"
                  value="<%= typeof(size) === 'undefined' ? '' : size %>"
                  placeholder="平方米"
                />
              </div>
            </div>
      
            <div class='control-group'>
              <label class='control-label' for='roomNum'>房间数</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='roomNum'
                  name='roomNum'
                  type='number'
                  min="0"
                  value="<%= typeof(roomNum) === 'undefined' ? '' : roomNum %>"
                />
              </div>
            </div>

            <div class='control-group'>
              <label class='control-label' for='phone'>电话</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='phone'
                  name='phone'
                  type='text'
                  value="<%= typeof(phone) === 'undefined' ? '' : phone %>"
                />
              </div>
            </div>

            <div class='control-group'>
              <label class='control-label' for='startDate'>起始时间</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='startDate'
                  name='startDate'
                  type='date'
                  value="<%= typeof(startDate) === 'undefined' ? '' : startDate %>"
                />
              </div>
            </div>

            <div class='control-group'>
              <label class='control-label' for='endDate'>结束时间</label>
              <div class='controls'>
                <input
                  class='input-xlarge'
                  id='endDate'
                  name='endDate'
                  type='date'
                  value="<%= typeof(endDate) === 'undefined' ? '' : endDate %>"
                />
              </div>
            </div>
          </div>
            <!--如果是租房信息则显示填写房屋信息的部分-->

            <div class='markdown_editor in_editor'>
              <div class='markdown_in_editor'>
                <textarea 
                  class='editor'
                  name='t_content'
                  rows='20'
                  placeholder='文章支持 Markdown 语法, 请注意标记代码'
                >
                  <%= typeof(content) !== 'undefined' && content || '' %>
                </textarea>

                <div class='editor_buttons'>
                  <input 
                    type="submit"
                    class='span-primary submit_btn'
                    data-loading-text="提交中"
                    value="提交"
                  />
                </div>
              </div>

            </div>

            <input type='hidden' id='topic_tags' name='topic_tags' value=''>
            <input type='hidden' name='_csrf' value='<%= csrf %>'>
          </fieldset>
        </form>
    </div>
    <% } %>
  </div>
</div>

<!-- markdown editor -->
<%- partial('../includes/editor') %>
<script>
  (function () {
    var editor = new Editor();
    editor.render($('.editor')[0]);

    var tabVal = $('#tab-value').val();
    if (tabVal === 'rental') {
      $('#rental').show();
    }

    // 版块选择的检查，必须选择
    $('#create_topic_form').on('submit', function (e) {
      $('.control-group').each(function(index, item) {
        $(item).removeClass('error');
      });
      var tabValue = $('#tab-value').val();
      if (!tabValue) {
        alert('必须选择一个版块！');
        $('.submit_btn').button('reset');
        $('#tab-value').closest('.control-group').addClass('error');
        return false;
      } else if (tabValue === 'rental') {
        // 选择租房板块时

        var ids = ['addr', 'price', 'size', 'roomNum', 'phone', 'startDate', 'endDate'];
        var noValIds = [];
        $('#rental input').each(function(index, elem) {
          var val = $(elem).val().trim();
          if (!val) {
            noValIds.push(index);
          }
        });
        var cityValue = $('#city-value').val();
        if (noValIds.length !== 0 || !cityValue) {
          noValIds.forEach(function(item) {
            var id = ids[item];
            $('#' + id).closest('.control-group').addClass('error');
          });
          $('#city-value').closest('.control-group').addClass('error');
          alert('信息未填完整');
          $('.submit_btn').button('reset');
          return false;
        }
      }
      // 标题检查
      var titleVal = $('#title').val().trim();
      if (!titleVal) {
        $('#title').closest('.control-group').addClass('error');
        alert('未填写标题');
        $('.submit_btn').button('reset');
        return false;
      }
      
    });
    // END 版块选择的检查，必须选择

    // 选择租房版块时，显示额外信息
    $('#tab-value').on('change', function () {
      var $this = $(this);
      var value = $this.val();
      var warnMsg = '';
      if (value === 'rental') {
        $('#rental').show();
      } else {
        $('#rental').hide();
      }
    });
    // END 选择租房版块时，显示额外信息

  })();
</script>
